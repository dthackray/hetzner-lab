# Traefik Configuration for hetzner-lab cluster

# Deployment configuration - DaemonSet to run on all nodes for HA
deployment:
  kind: DaemonSet
  podAnnotations:
    prometheus.io/port: "8082"
    prometheus.io/scrape: "true"
  # Volume for plugin storage (Traefik hardcodes /plugins-storage)
  additionalVolumes:
    - name: plugins-storage
      emptyDir: {}
    - name: crowdsec-bouncer-key
      secret:
        secretName: crowdsec-bouncer-key
        optional: true # Allow Traefik to start before secret exists

# Service configuration - Using LoadBalancer with Hetzner CCM
service:
  type: LoadBalancer
  annotations:
    load-balancer.hetzner.cloud/name: hetzner-cluster-1-ingress
    load-balancer.hetzner.cloud/location: nbg1
  spec:
    externalTrafficPolicy: Local

# Ports configuration
ports:
  # HTTP
  web:
    port: 8000
    exposedPort: 80
    protocol: TCP
    # Apply geoblock before redirect to reject blocked countries early
    middlewares:
      - default-geoblock@kubernetescrd
  # HTTPS
  websecure:
    port: 8443
    exposedPort: 443
    protocol: TCP
    tls:
      enabled: true
    # Global security middlewares - applied to ALL HTTPS traffic
    middlewares:
      - default-geoblock@kubernetescrd
      - default-crowdsec@kubernetescrd
      - default-bot-wrangler@kubernetescrd
  # Metrics
  metrics:
    port: 8082
    exposedPort: 8082
    protocol: TCP
  # Dashboard/API
  traefik:
    port: 9000
    exposedPort: 9000
    protocol: TCP

# Dashboard configuration
ingressRoute:
  dashboard:
    enabled: false # Disabled - using custom IngressRoute with Authentik in extraObjects

# Enable dashboard via API
api:
  dashboard: true
  insecure: false # Secured via Authentik ForwardAuth

# Logs configuration
logs:
  general:
    level: INFO
  access:
    enabled: true
    format: json

# Metrics for Prometheus
metrics:
  prometheus:
    enabled: true
    entryPoint: metrics
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true

# Global redirect configuration (HTTP to HTTPS)
# Disabled for now - we'll enable after cert-manager is setup
# globalArguments:
#   - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
#   - "--entrypoints.web.http.redirections.entryPoint.scheme=https"

# Additional command line arguments
additionalArguments:
  # Enable experimental plugins with correct versions
  - "--experimental.plugins.realplugin.modulename=github.com/Paxxs/traefik-get-real-ip"
  - "--experimental.plugins.realplugin.version=v1.0.2"
  - "--experimental.plugins.fail2ban.modulename=github.com/tomMoulard/fail2ban"
  - "--experimental.plugins.fail2ban.version=v0.8.9"
  - "--experimental.plugins.geoblock.modulename=github.com/PascalMinder/geoblock"
  - "--experimental.plugins.geoblock.version=v0.3.4"
  - "--experimental.plugins.crowdsec.modulename=github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
  - "--experimental.plugins.crowdsec.version=v1.4.6"
  - "--experimental.plugins.wrangler.modulename=github.com/holysoles/bot-wrangler-traefik-plugin"
  - "--experimental.plugins.wrangler.version=v0.10.1"
  # HTTP to HTTPS redirect
  - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
  - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
  - "--entrypoints.web.http.redirections.entryPoint.permanent=true"

# Providers configuration
providers:
  kubernetesCRD:
    enabled: true
    allowCrossNamespace: true
    allowExternalNameServices: true
  kubernetesIngress:
    enabled: true
    allowExternalNameServices: true
    publishedService:
      enabled: true

# Pilot (Traefik Hub) - disabled
pilot:
  enabled: false

# Priority class for pod scheduling
priorityClassName: "system-cluster-critical"

# Tolerations to run on control plane nodes
tolerations:
  - key: "CriticalAddonsOnly"
    operator: "Exists"
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Exists"
    effect: "NoSchedule"

# Security context
# Note: readOnlyRootFilesystem disabled to allow plugin loading
securityContext:
  capabilities:
    drop: [ALL]
    add: [NET_BIND_SERVICE]
  readOnlyRootFilesystem: false
  runAsGroup: 65532
  runAsNonRoot: true
  runAsUser: 65532

podSecurityContext:
  fsGroup: 65532

# Mount plugin storage as writable
additionalVolumeMounts:
  - name: plugins-storage
    mountPath: /plugins-storage
    readOnly: false
  - name: crowdsec-bouncer-key
    mountPath: /etc/traefik/crowdsec
    readOnly: true

# Extra Kubernetes objects to deploy with Traefik
extraObjects:
  # CrowdSec Bouncer API Key (SealedSecret)
  - apiVersion: bitnami.com/v1alpha1
    kind: SealedSecret
    metadata:
      name: crowdsec-bouncer-key
      namespace: kube-system
    spec:
      encryptedData:
        api-key: AgAXcrthgUnjFXTQsNIdZ8HwjbPrt0gOA73r2o7SEXfxE8AF3EntFaH6KDZpJZFt+CZC7+RRn7YYd1tjHKtAfkI54RH1mEoyoP7DNPnUe/u9abyHZjNEiazACzgv1sybuMow5YjgHqEDHqR2eTD99kVMaEMiq4D0jvZixyYNAg3nTLJMy+8tYVdGuX9ybig6HiG38vUi2dkqpJgxHCy5RXELwQNFHRPhL5HaqR5k5C2uYfsD5Tnzg2xqJjqGglbVK2gatfWIWVkS9Tg1ycgUL5qwbPsM+L9kc8hg9ttcYpZHmy+nRba209cdDKmA/DxZjmf6lUM/roXBzlkSyEuulXGyqPnZBTZ24rNJkGP36WQcyiM5gE7vBaJcOs3n0YgjRWmAcuzivMgSHZq8FDcTe70AuslcIN9tC0x38oVSSgOvL1L5OILhGshk/K3sFp9zyncoW/RDI7qu8xW/Vjn99WPzQLBN9xhf/3qqafMHkSklT1aR7/GhIngrMXVGsiXQXno4roJLgs0zlvxmVdDphW1BSCKzViTnitCWite9H0R8/1A3GnUztafVRSNUVQWDmOARqBSneCC/7PZz6ehL2kZubXFPQb6BqK+aRg7dqnap/IGxl+5LHRHLMTnooxipsIVqhHu2UwVapmqH6VLA/GZVmlJ+4AK7CXYCl5A22Ug+RIFHIKEHMB3ZK4v2Bpf4ZVO7T/GGIcEcuHfLW9Aq6PpkmWhZiP0qxgW8C/LPxOPOxja0nxNQsXW1Pu9I
      template:
        metadata:
          name: crowdsec-bouncer-key
          namespace: kube-system

  # Authentik ForwardAuth Middleware
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: authentik
      namespace: default
    spec:
      forwardAuth:
        # Point to the Authentik outpost endpoint
        address: http://authentik-server.authentik.svc.cluster.local/outpost.goauthentik.io/auth/traefik
        trustForwardHeader: true
        # Forward these headers from Authentik to the backend application
        authResponseHeaders:
          - X-authentik-username
          - X-authentik-groups
          - X-authentik-email
          - X-authentik-name
          - X-authentik-uid
          - X-authentik-jwt
          - X-authentik-meta-jwks
          - X-authentik-meta-outpost
          - X-authentik-meta-provider
          - X-authentik-meta-app
          - X-authentik-meta-version

  # Traefik Dashboard IngressRoute
  - apiVersion: traefik.io/v1alpha1
    kind: IngressRoute
    metadata:
      name: traefik-dashboard
      namespace: kube-system
    spec:
      entryPoints:
        - websecure
      routes:
        - match: Host(`traefik.dthackray.com`)
          kind: Rule
          middlewares:
            - name: authentik
              namespace: default
          services:
            - name: api@internal
              kind: TraefikService
      tls:
        secretName: traefik-dashboard-tls

  # Certificate for Traefik Dashboard
  - apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: traefik-dashboard-tls
      namespace: kube-system
    spec:
      secretName: traefik-dashboard-tls
      issuerRef:
        name: letsencrypt-prod
        kind: ClusterIssuer
      dnsNames:
        - traefik.dthackray.com

  # GeoBlock Middleware - Allow UK and allied countries only
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: geoblock
      namespace: default
    spec:
      plugin:
        geoblock:
          allowLocalRequests: true
          allowUnknownCountries: false
          api: "https://get.geojs.io/v1/ip/country/{ip}"
          apiTimeoutMs: 500
          # Cache size for IP lookups
          cacheSize: 100
          # Log API requests for debugging
          logApiRequests: true
          # Allowed countries (UK + allies)
          countries:
            - GB
            - IE
            - AT # Austria
            - BE # Belgium
            - BG # Bulgaria
            - HR # Croatia
            - CY # Cyprus
            - CZ # Czechia
            - DK # Denmark
            - EE # Estonia
            - FI # Finland
            - FR # France
            - DE # Germany
            - GR # Greece
            - HU # Hungary
            - IT # Italy
            - LV # Latvia
            - LT # Lithuania
            - LU # Luxembourg
            - MT # Malta
            - NL # Netherlands
            - PL # Poland
            - PT # Portugal
            - RO # Romania
            - SK # Slovakia
            - SI # Slovenia
            - ES # Spain
            - SE # Sweden
            - US # United States
            - CA # Canada
            - AU # Australia
            - NZ # New Zealand

  # CrowdSec Bouncer Middleware (Streaming mode for better performance)
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: crowdsec
      namespace: default
    spec:
      plugin:
        crowdsec:
          enabled: true
          logLevel: INFO
          # Streaming mode: keeps only banned IPs in cache, syncs periodically
          crowdsecMode: stream
          crowdsecLapiScheme: http
          crowdsecLapiHost: crowdsec-service.crowdsec.svc.cluster.local:8080
          # API key mounted from secret
          crowdsecLapiKeyFile: /etc/traefik/crowdsec/api-key
          # Sync banned IPs every 60 seconds
          updateIntervalSeconds: 60
          # Allow local IPs to bypass
          clientTrustedIPs:
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16

  # Bot Wrangler - Detects AI bots and proxies them to Iocaine
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: bot-wrangler
      namespace: default
    spec:
      plugin:
        wrangler:
          enabled: true
          # PROXY: Send AI bots to iocaine for poisoning
          botAction: PROXY
          botProxyUrl: http://iocaine.default.svc.cluster.local:42069
          logLevel: INFO
          # Refresh bot list every 24 hours
          cacheUpdateInterval: 24h

  # Security Chain - Combines all security middlewares
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: security-chain
      namespace: default
    spec:
      chain:
        middlewares:
          - name: geoblock
            namespace: default
          - name: crowdsec
            namespace: default
          - name: bot-wrangler
            namespace: default

  # Redirect root domain to homepage
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: redirect-to-home
      namespace: default
    spec:
      redirectRegex:
        regex: "^https://dthackray\\.com/(.*)"
        replacement: "https://home.dthackray.com/${1}"
        permanent: true

  # Root domain Ingress - redirects to home.dthackray.com
  # Using standard Ingress so external-dns creates the DNS record
  - apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: root-domain-redirect
      namespace: default
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        traefik.ingress.kubernetes.io/router.middlewares: default-redirect-to-home@kubernetescrd
    spec:
      ingressClassName: traefik
      rules:
        - host: dthackray.com
          http:
            paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    # Dummy service - redirect happens before reaching backend
                    name: homepage
                    port:
                      number: 3000
      tls:
        - hosts:
            - dthackray.com
          secretName: root-domain-tls
