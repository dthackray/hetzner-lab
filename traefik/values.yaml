# Traefik Configuration for hetzner-lab cluster

# Deployment configuration - DaemonSet to run on all nodes for HA
deployment:
  kind: DaemonSet
  podAnnotations:
    prometheus.io/port: "8082"
    prometheus.io/scrape: "true"
  # Volume for plugin storage (Traefik hardcodes /plugins-storage)
  additionalVolumes:
    - name: plugins-storage
      emptyDir: {}
    - name: plugins-local
      emptyDir: {}
    - name: crowdsec-bouncer-key
      secret:
        secretName: crowdsec-bouncer-key
        optional: true # Allow Traefik to start before secret exists
  # InitContainer to clone iocaine plugin (not available on Traefik plugin registry)
  initContainers:
    - name: clone-iocaine-plugin
      image: alpine/git:latest
      command:
        - sh
        - -c
        - |
          mkdir -p /plugins-local/src/git.mstar.dev/mstar
          git clone https://git.mstar.dev/mstar/traefik-iocaine-middleware.git \
            /plugins-local/src/git.mstar.dev/mstar/traefik-iocaine-middleware
      volumeMounts:
        - name: plugins-local
          mountPath: /plugins-local

# Service configuration - Using LoadBalancer with Hetzner CCM
service:
  type: LoadBalancer
  annotations:
    load-balancer.hetzner.cloud/name: hetzner-cluster-1-ingress
    load-balancer.hetzner.cloud/location: nbg1
  spec:
    externalTrafficPolicy: Local

# Ports configuration
ports:
  # HTTP
  web:
    port: 8000
    exposedPort: 80
    protocol: TCP
  # HTTPS
  websecure:
    port: 8443
    exposedPort: 443
    protocol: TCP
    tls:
      enabled: true
  # Metrics
  metrics:
    port: 8082
    exposedPort: 8082
    protocol: TCP
  # Dashboard/API
  traefik:
    port: 9000
    exposedPort: 9000
    protocol: TCP

# Dashboard configuration
ingressRoute:
  dashboard:
    enabled: false # Disabled - using custom IngressRoute with Authentik in extraObjects

# Enable dashboard via API
api:
  dashboard: true
  insecure: false # Secured via Authentik ForwardAuth

# Logs configuration
logs:
  general:
    level: INFO
  access:
    enabled: true
    format: json

# Metrics for Prometheus
metrics:
  prometheus:
    enabled: true
    entryPoint: metrics
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true

# Global redirect configuration (HTTP to HTTPS)
# Disabled for now - we'll enable after cert-manager is setup
# globalArguments:
#   - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
#   - "--entrypoints.web.http.redirections.entryPoint.scheme=https"

# Additional command line arguments
additionalArguments:
  # Enable experimental plugins with correct versions
  - "--experimental.plugins.realplugin.modulename=github.com/Paxxs/traefik-get-real-ip"
  - "--experimental.plugins.realplugin.version=v1.0.2"
  - "--experimental.plugins.fail2ban.modulename=github.com/tomMoulard/fail2ban"
  - "--experimental.plugins.fail2ban.version=v0.8.9"
  - "--experimental.plugins.geoblock.modulename=github.com/PascalMinder/geoblock"
  - "--experimental.plugins.geoblock.version=v0.3.4"
  - "--experimental.plugins.crowdsec.modulename=github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
  - "--experimental.plugins.crowdsec.version=v1.3.5"
  # Iocaine local plugin
  - "--experimental.localPlugins.iocaine.moduleName=git.mstar.dev/mstar/traefik-iocaine-middleware"

# Providers configuration
providers:
  kubernetesCRD:
    enabled: true
    allowCrossNamespace: true
    allowExternalNameServices: true
  kubernetesIngress:
    enabled: true
    allowExternalNameServices: true
    publishedService:
      enabled: true

# Pilot (Traefik Hub) - disabled
pilot:
  enabled: false

# Priority class for pod scheduling
priorityClassName: "system-cluster-critical"

# Tolerations to run on control plane nodes
tolerations:
  - key: "CriticalAddonsOnly"
    operator: "Exists"
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Exists"
    effect: "NoSchedule"

# Security context
# Note: readOnlyRootFilesystem disabled to allow plugin loading
securityContext:
  capabilities:
    drop: [ALL]
    add: [NET_BIND_SERVICE]
  readOnlyRootFilesystem: false
  runAsGroup: 65532
  runAsNonRoot: true
  runAsUser: 65532

podSecurityContext:
  fsGroup: 65532

# Mount plugin storage as writable
additionalVolumeMounts:
  - name: plugins-storage
    mountPath: /plugins-storage
    readOnly: false
  - name: plugins-local
    mountPath: /plugins-local
    readOnly: true
  - name: crowdsec-bouncer-key
    mountPath: /etc/traefik/crowdsec
    readOnly: true

# Extra Kubernetes objects to deploy with Traefik
extraObjects:
  # Authentik ForwardAuth Middleware
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: authentik
      namespace: default
    spec:
      forwardAuth:
        # Point to the Authentik outpost endpoint
        address: http://authentik-server.authentik.svc.cluster.local/outpost.goauthentik.io/auth/traefik
        trustForwardHeader: true
        # Forward these headers from Authentik to the backend application
        authResponseHeaders:
          - X-authentik-username
          - X-authentik-groups
          - X-authentik-email
          - X-authentik-name
          - X-authentik-uid
          - X-authentik-jwt
          - X-authentik-meta-jwks
          - X-authentik-meta-outpost
          - X-authentik-meta-provider
          - X-authentik-meta-app
          - X-authentik-meta-version

  # Traefik Dashboard IngressRoute
  - apiVersion: traefik.io/v1alpha1
    kind: IngressRoute
    metadata:
      name: traefik-dashboard
      namespace: kube-system
    spec:
      entryPoints:
        - websecure
      routes:
        - match: Host(`traefik.dthackray.com`)
          kind: Rule
          middlewares:
            - name: authentik
              namespace: default
          services:
            - name: api@internal
              kind: TraefikService
      tls:
        secretName: traefik-dashboard-tls

  # Certificate for Traefik Dashboard
  - apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: traefik-dashboard-tls
      namespace: kube-system
    spec:
      secretName: traefik-dashboard-tls
      issuerRef:
        name: letsencrypt-prod
        kind: ClusterIssuer
      dnsNames:
        - traefik.dthackray.com

  # GeoBlock Middleware - Allow UK and allied countries only
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: geoblock
      namespace: default
    spec:
      plugin:
        geoblock:
          allowLocalRequests: true
          allowUnknownCountries: false
          api: "https://get.geojs.io/v1/ip/country/{ip}"
          apiTimeoutMs: 500
          # Cache size for IP lookups
          cacheSize: 100
          # Log API requests for debugging
          logApiRequests: true
          # Allowed countries (UK + allies)
          countries:
            - GB
            - IE
            - AT # Austria
            - BE # Belgium
            - BG # Bulgaria
            - HR # Croatia
            - CY # Cyprus
            - CZ # Czechia
            - DK # Denmark
            - EE # Estonia
            - FI # Finland
            - FR # France
            - DE # Germany
            - GR # Greece
            - HU # Hungary
            - IT # Italy
            - LV # Latvia
            - LT # Lithuania
            - LU # Luxembourg
            - MT # Malta
            - NL # Netherlands
            - PL # Poland
            - PT # Portugal
            - RO # Romania
            - SK # Slovakia
            - SI # Slovenia
            - ES # Spain
            - SE # Sweden
            - US # United States
            - CA # Canada
            - AU # Australia
            - NZ # New Zealand

  # CrowdSec Bouncer Middleware
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: crowdsec
      namespace: default
    spec:
      plugin:
        crowdsec:
          enabled: true
          logLevel: INFO
          crowdsecMode: live
          crowdsecLapiScheme: http
          crowdsecLapiHost: crowdsec-lapi.crowdsec.svc.cluster.local:8080
          # API key mounted from secret
          crowdsecLapiKeyFile: /etc/traefik/crowdsec/api-key
          updateIntervalSeconds: 60
          # Allow local IPs to bypass
          clientTrustedIPs:
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16

  # Iocaine AI Bot Poisoner Middleware
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: iocaine
      namespace: default
    spec:
      plugin:
        iocaine:
          iocaineHttpUrl: http://iocaine.default.svc.cluster.local:42069
          methods:
            - GET
            - HEAD

  # Security Chain - Combines all security middlewares
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: security-chain
      namespace: default
    spec:
      chain:
        middlewares:
          - name: geoblock
            namespace: default
          - name: crowdsec
            namespace: default
          - name: iocaine
            namespace: default
